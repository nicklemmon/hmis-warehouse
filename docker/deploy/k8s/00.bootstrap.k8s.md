# Setting up testing cluster

This section is done once.

## Set profile for awscli that can do the following things

        export AWS_PROFILE=openpath

## Make a cluster

Takes 10-15 minutes. Ensure that the IP address range doesn't collide
with the one for the database or cache as that will disallow vpc peering
(i.e. connectivity with RDS instance that's not publicly available).

<pre>

eksctl create cluster \
  --name openpath \
  --version 1.14 \
  --region us-east-1 \
  --nodegroup-name frontend \
  --node-type t3.small \
  --nodes 2 \
  --nodes-min 1 \
  --nodes-max 4 \
  --ssh-access \
  --ssh-public-key blackman \
  --managed

</pre>

check on issues building with this or go to the cloudformation page in AWS

        eksctl utils describe-stacks --region=us-east-1 --cluster=openpath


## See the nodes with standard k8s tools.

The create cluster command should have made this next command work

        kubectl get nodes

If the kubectl command didn't work see
[this](https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html)

## WIP: Run as yet unwritten ansible against these servers. Like pam-sudo, per-user logins instead of ubuntu, etc.

## Tag all subnets so k8s knows which it can use for load balancing

* [docs](https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html)

* All subnets get this tag. It should be automatic when using the eksctl tool

  kubernetes.io/cluster/openpath=shared

* external subnets
        kubernetes.io/role/elb=1

* internal subnets
        kubernetes.io/role/internal-elb=1

## Make Open ID Connect provider

[IAM identity providers](https://console.aws.amazon.com/iam/home?region=us-east-1#/providers)
[What is Open ID](https://openid.net/what-is-openid/)

<pre>

eksctl utils associate-iam-oidc-provider \
    --region us-east-1 \
    --cluster openpath \
    --approve

</pre>


## Make policy so ingress controller can talk to AWS api

This failed via api, but pasting into IAM worked.

        aws iam create-policy \
            --policy-name ALBIngressControllerIAMPolicy \
            --policy-document k8s/ingress.policy.json

## Make role for the ingress controller

       kubectl apply -f k8s/alb-cluster-role.yml

## Update security groups for RDS and cache

Allow the k8s vpc in/out of the database (192.168.0.0/16)

## WIP: Enable cluster logging

        eksctl utils update-cluster-logging --region=us-east-1 --cluster=openpath

## Peer the k8s cluster vpc to the "legacy" vpc to allow database and redis connections

https://docs.aws.amazon.com/vpc/latest/peering/create-vpc-peering-connection.html
https://docs.aws.amazon.com/vpc/latest/peering/vpc-peering-routing.html

* Add peering connection with private DNS resolution for k8s
* Modify all private k8s subnets to get to legacy
* Modify legacy to get to k8s
